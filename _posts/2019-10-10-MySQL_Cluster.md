---
layout: post
title: MySQL分布式集群
date: 2019-10-10
tag: MySQL
---

# 一、背景
之前看到了服务的分布式转发和负载均衡，这些方法都能分担服务器的压力，提高访问效率，但是服务处理速度的瓶颈会被数据库的访问限制，如果服务器是分布式的，而数据库集群是单台服务器，那么效率肯定也是很低的，因此了解一下MySQL的分布式集群。
# 二、MySQL集群
MySQL集群是一个无共享的(shared-nothing)、分布式节点架构的存储方案，其目的是提供容错性和高性能
数据更新使用读已提交隔离级别（read-committedisolation)来保证所有节点数据的一致性，使用两阶段提交机制（two-phasedcommit)保证所有节点都有相同的数据(如果任何一个写操作失败，则更新失败）。
无共享的对等节点使得某台服务器上的更新操作在其他服务器上立即可见。传播更新使用一种复杂的通信机制，这一机制专用来提供跨网络的高吞吐量。
通过多个MySQL服务器分配负载，从而最大程序地达到高性能，通过在不同位置存储数据保证高可用性和冗余。

![image](https://yqfile.alicdn.com/d60ef274368dcc29cfb0b6cf35079a53fc74bfa7.png)

# 三、如何存储数据
1.Mysqlcluster数据节点组内主从同步采用的是同步复制，来保证组内节点数据的一致性。一般通过两阶段提交 协议来实现，一般工作过程如下：
a)Master执行提交语句时，事务被发送到slave，slave开始准备事务的提交。
b)每个slave都要准备事务，然后向master发送OK(或ABORT)消息，表明事务已经准备好（或者无法准备该事务）。
c)Master等待所有Slave发送OK或ABORT消息

```
如果Master收到所有 Slave的OK消息，它就会向所有Slave发送提交消息，告诉Slave提交该事务；
如果Master收到来自任何一个Slave的ABORT消息，它就向所有 Slave发送ABORT消息，告诉Slave去中止事务。
```
e)每个Slave等待来自Master的OK或ABORT消息。

```
如果Slave收到提交请求，它们就会提交事务，并向Master发送事务已提交 的确认；
如果Slave收到取消请求,它们就会撤销所有改变并释放所占有的资源，从而中止事务，然后向Masterv送事务已中止的确认。
```
f) 当Master收到来自所有Slave的确认后，就会报告该事务被提交（或中止），然后继续进行下一个事务处理。
由于同步复制一共需要4次消息传递，故mysql cluster的数据更新速度比单机mysql要慢。所以mysql cluster要求运行在千兆以上的局域网内，节点可以采用双网卡，节点组之间采用直连方式。